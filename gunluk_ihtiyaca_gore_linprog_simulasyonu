# =============================================================================
# EYLÃœL HAFTA SONU - Ä°KÄ° AÅAMALI LP OPTÄ°MÄ°ZASYONU
# Tam kod: Veri yÃ¼klemeden grafiklere kadar
# =============================================================================

import pandas as pd
import numpy as np
from scipy.optimize import linprog
import matplotlib.pyplot as plt

# =============================================================================
# 0. VERÄ° YÃœKLEME
# =============================================================================

print("Veriler yÃ¼kleniyor...")

df_shifts = pd.read_excel('vardiyalar.xlsx')
df_actual = pd.read_excel('gercek_calisanlar.xlsx')
df_actual['working_date'] = pd.to_datetime(df_actual['working_date'])

print(f"âœ“ Shift sayÄ±sÄ±: {len(df_shifts)}")
print(f"âœ“ GerÃ§ek Ã§alÄ±ÅŸan satÄ±r: {len(df_actual):,}")

queue_company_rules = {
    'a_cagrilari': ['inhouse', 'outsource'],
    'b_cagrilari': ['inhouse'],
    'c_cagrilari': ['inhouse']
}

# =============================================================================
# 1. YARDIMCI FONKSÄ°YONLAR
# =============================================================================

def is_slot_in_shift(slot, start, end):
    """Slot bu shift iÃ§inde mi?"""
    if start <= end:
        return start <= slot < end
    else:
        return slot >= start or slot < end


def create_shift_coverage_matrix(df_shifts):
    """Her shift'in hangi slotlarÄ± kapsadÄ±ÄŸÄ±nÄ± hesapla"""
    shift_coverage = {}
    
    for _, row in df_shifts.iterrows():
        shift = row['shift']
        start = str(row['start'])[:5]
        end = str(row['end'])[:5]
        company = row['company']
        
        key = f"{shift}_{company}"
        
        slots = []
        for h in range(24):
            for m in ['00', '30']:
                slot = f"{h:02d}:{m}"
                if is_slot_in_shift(slot, start, end):
                    slots.append(slot)
        
        shift_coverage[key] = {
            'shift': shift,
            'company': company,
            'start': start,
            'end': end,
            'slots': slots
        }
    
    return shift_coverage


def calculate_shift_slot_matrix(shift_coverage):
    """Shift-Slot binary matrisi"""
    slots = [f"{h:02d}:{m}" for h in range(24) for m in ['00', '30']]
    shifts = list(shift_coverage.keys())
    
    matrix = pd.DataFrame(0, index=slots, columns=shifts)
    
    for shift_key, info in shift_coverage.items():
        for slot in info['slots']:
            matrix.loc[slot, shift_key] = 1
    
    return matrix


def calculate_actual_by_slot(df_actual, date, queue):
    """Belirli gÃ¼n ve kuyruk iÃ§in slot bazÄ±nda gerÃ§ek Ã§alÄ±ÅŸan (TOPLAM)"""
    df_day = df_actual[
        (df_actual['working_date'] == date) &
        (df_actual['line_based_main_group'] == queue)
    ]
    
    slots = [f"{h:02d}:{m}" for h in range(24) for m in ['00', '30']]
    actual_by_slot = {}
    
    for slot in slots:
        count = 0
        for _, row in df_day.iterrows():
            start = str(row['shifts_start_hour'])[:5]
            end = str(row['shifts_end_hour'])[:5]
            
            if is_slot_in_shift(slot, start, end):
                count += row['calisan_kisi_sayisi']
        
        actual_by_slot[slot] = count
    
    return actual_by_slot


# =============================================================================
# 2. Ä°KÄ° AÅAMALI LP FONKSÄ°YONU
# =============================================================================

def optimize_two_stage(need_by_slot, df_shift_matrix, 
                       target_min=0.55, target_max=0.60):
    """
    Ä°ki aÅŸamalÄ± optimizasyon:
    1. Ã–nce serbest Ã§Ã¶z
    2. GÃ¼nlÃ¼k oran hedefte deÄŸilse, gÃ¼nlÃ¼k toplam constraint ekle
    """
    
    slots = df_shift_matrix.index.tolist()
    shifts = df_shift_matrix.columns.tolist()
    active_slots = [s for s in slots if need_by_slot.get(s, 0) > 0]
    
    if not active_slots:
        return None, "Aktif slot yok"
    
    # Shift'leri ayÄ±r
    inhouse_shifts = [s for s in shifts if '_inhouse' in s.lower()]
    outsource_shifts = [s for s in shifts if '_outsource' in s.lower()]
    
    inhouse_idx = [i for i, s in enumerate(shifts) if s in inhouse_shifts]
    outsource_idx = [i for i, s in enumerate(shifts) if s in outsource_shifts]
    
    # Maliyet vektÃ¶rÃ¼ (eÅŸit)
    c = [1.0] * len(shifts)
    
    # Temel kÄ±sÄ±tlar: her slot iÃ§in ihtiyacÄ± karÅŸÄ±la
    A_ub = []
    b_ub = []
    
    for slot in active_slots:
        row = []
        for s in shifts:
            if df_shift_matrix.loc[slot, s] == 1:
                row.append(-1)
            else:
                row.append(0)
        A_ub.append(row)
        b_ub.append(-need_by_slot[slot])
    
    bounds = [(0, 200)] * len(shifts)
    
    # =========================================
    # AÅAMA 1: Serbest Ã§Ã¶z (sadece ihtiyaÃ§)
    # =========================================
    
    result1 = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method='highs')
    
    if not result1.success:
        return None, "AÅŸama 1 baÅŸarÄ±sÄ±z"
    
    # GÃ¼nlÃ¼k oranÄ± hesapla
    total_inhouse = sum(result1.x[i] for i in inhouse_idx)
    total_outsource = sum(result1.x[i] for i in outsource_idx)
    total = total_inhouse + total_outsource
    
    if total == 0:
        return None, "Toplam sÄ±fÄ±r"
    
    current_ratio = total_outsource / total
    
    # Hedefte mi kontrol et
    if target_min <= current_ratio <= target_max:
        # Zaten hedefte, AÅŸama 1 yeterli
        assignments = {}
        for i, shift in enumerate(shifts):
            if result1.x[i] > 0.01:
                assignments[shift] = int(np.ceil(result1.x[i]))
        return assignments, f"AÅŸama 1 yeterli ({current_ratio:.1%})"
    
    # =========================================
    # AÅAMA 2: GÃ¼nlÃ¼k constraint ekle
    # =========================================
    
    # Minimum: outsource >= target_min * total
    # Linprog formatÄ±: target_min*inhouse - (1-target_min)*outsource <= 0
    row_min = [0] * len(shifts)
    for i in inhouse_idx:
        row_min[i] = target_min
    for i in outsource_idx:
        row_min[i] = -(1 - target_min)
    
    # Maximum: outsource <= target_max * total
    # Linprog formatÄ±: -target_max*inhouse + (1-target_max)*outsource <= 0
    row_max = [0] * len(shifts)
    for i in inhouse_idx:
        row_max[i] = -target_max
    for i in outsource_idx:
        row_max[i] = (1 - target_max)
    
    A_ub.append(row_min)
    b_ub.append(0)
    
    A_ub.append(row_max)
    b_ub.append(0)
    
    result2 = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method='highs')
    
    if result2.success:
        new_inhouse = sum(result2.x[i] for i in inhouse_idx)
        new_outsource = sum(result2.x[i] for i in outsource_idx)
        new_ratio = new_outsource / (new_inhouse + new_outsource)
        
        assignments = {}
        for i, shift in enumerate(shifts):
            if result2.x[i] > 0.01:
                assignments[shift] = int(np.ceil(result2.x[i]))
        return assignments, f"AÅŸama 2 ({current_ratio:.1%} â†’ {new_ratio:.1%})"
    else:
        assignments = {}
        for i, shift in enumerate(shifts):
            if result1.x[i] > 0.01:
                assignments[shift] = int(np.ceil(result1.x[i]))
        return assignments, f"AÅŸama 2 baÅŸarÄ±sÄ±z, AÅŸama 1 ({current_ratio:.1%})"


# =============================================================================
# 3. ANALÄ°Z FONKSÄ°YONU
# =============================================================================

def analyze_lp_result(lp_assignments, shift_coverage, df_shift_matrix, actual_by_slot):
    """LP sonucunu analiz et"""
    
    if lp_assignments is None:
        return None
    
    # Slot bazÄ±nda company daÄŸÄ±lÄ±mÄ±
    company_by_slot = {'inhouse': {}, 'outsource': {}}
    
    for slot in df_shift_matrix.index:
        inhouse_total = 0
        outsource_total = 0
        
        for shift, count in lp_assignments.items():
            if shift in shift_coverage and df_shift_matrix.loc[slot, shift] == 1:
                info = shift_coverage[shift]
                if info['company'] == 'inhouse':
                    inhouse_total += count
                else:
                    outsource_total += count
        
        company_by_slot['inhouse'][slot] = inhouse_total
        company_by_slot['outsource'][slot] = outsource_total
    
    # GÃ¼nlÃ¼k toplam
    total_inhouse = sum([count for shift, count in lp_assignments.items() 
                         if shift in shift_coverage and shift_coverage[shift]['company'] == 'inhouse'])
    total_outsource = sum([count for shift, count in lp_assignments.items() 
                           if shift in shift_coverage and shift_coverage[shift]['company'] == 'outsource'])
    
    total = total_inhouse + total_outsource
    
    # Zirve slot
    if actual_by_slot:
        max_slot = max(actual_by_slot.items(), key=lambda x: x[1])[0]
        inhouse_peak = company_by_slot['inhouse'].get(max_slot, 0)
        outsource_peak = company_by_slot['outsource'].get(max_slot, 0)
    else:
        max_slot = None
        inhouse_peak = 0
        outsource_peak = 0
    
    return {
        'total': total,
        'inhouse': total_inhouse,
        'outsource': total_outsource,
        'inhouse_pct': total_inhouse / total * 100 if total > 0 else 0,
        'outsource_pct': total_outsource / total * 100 if total > 0 else 0,
        'peak_slot': max_slot,
        'peak_inhouse': inhouse_peak,
        'peak_outsource': outsource_peak,
        'peak_inhouse_pct': inhouse_peak / (inhouse_peak + outsource_peak) * 100 if (inhouse_peak + outsource_peak) > 0 else 0,
        'peak_outsource_pct': outsource_peak / (inhouse_peak + outsource_peak) * 100 if (inhouse_peak + outsource_peak) > 0 else 0,
        'company_by_slot': company_by_slot
    }


# =============================================================================
# 4. KARÅILAÅTIRMA GRAFÄ°K FONKSÄ°YONU
# =============================================================================

def calculate_actual_by_slot_by_company(df_actual, date, queue):
    """Slot bazÄ±nda inhouse/outsource ayrÄ± hesapla"""
    df_day = df_actual[
        (df_actual['working_date'] == date) &
        (df_actual['line_based_main_group'] == queue)
    ]
    
    slots = [f"{h:02d}:{m}" for h in range(24) for m in ['00', '30']]
    
    actual_inhouse = {}
    actual_outsource = {}
    
    for slot in slots:
        count_in = 0
        count_out = 0
        
        for _, row in df_day.iterrows():
            start = str(row['shifts_start_hour'])[:5]
            end = str(row['shifts_end_hour'])[:5]
            
            if is_slot_in_shift(slot, start, end):
                if row['outsource_flg'] == 0:
                    count_in += row['calisan_kisi_sayisi']
                else:
                    count_out += row['calisan_kisi_sayisi']
        
        actual_inhouse[slot] = count_in
        actual_outsource[slot] = count_out
    
    return actual_inhouse, actual_outsource


def calculate_actual_by_start_hour(df_actual, date, queue):
    """Vardiya baÅŸlangÄ±Ã§ saatine gÃ¶re inhouse/outsource kiÅŸi sayÄ±sÄ±"""
    df_day = df_actual[
        (df_actual['working_date'] == date) &
        (df_actual['line_based_main_group'] == queue)
    ]
    
    actual_inhouse_start = {}
    actual_outsource_start = {}
    
    for _, row in df_day.iterrows():
        start = str(row['shifts_start_hour'])[:5]
        count = row['calisan_kisi_sayisi']
        
        if row['outsource_flg'] == 0:
            actual_inhouse_start[start] = actual_inhouse_start.get(start, 0) + count
        else:
            actual_outsource_start[start] = actual_outsource_start.get(start, 0) + count
    
    return actual_inhouse_start, actual_outsource_start


def compare_actual_vs_lp(date, queue, df_actual, lp_assignments, shift_coverage, df_shift_matrix):
    """
    GerÃ§ek vs LP karÅŸÄ±laÅŸtÄ±rmasÄ± - 4 grafik:
    1. Inhouse vardiya baÅŸlangÄ±Ã§ saatleri
    2. Outsource vardiya baÅŸlangÄ±Ã§ saatleri
    3. Slot bazÄ±nda toplam kiÅŸi sayÄ±sÄ±
    4. Slot bazÄ±nda Inhouse vs Outsource
    """
    
    date_str = pd.to_datetime(date).strftime('%Y-%m-%d')
    slots = [f"{h:02d}:{m}" for h in range(24) for m in ['00', '30']]
    
    # =========================================
    # GERÃ‡EK VERÄ°LER
    # =========================================
    
    actual_inhouse_start, actual_outsource_start = calculate_actual_by_start_hour(df_actual, date, queue)
    actual_inhouse_slot, actual_outsource_slot = calculate_actual_by_slot_by_company(df_actual, date, queue)
    
    # =========================================
    # LP VERÄ°LER
    # =========================================
    
    # Vardiya baÅŸlangÄ±Ã§ saatlerine gÃ¶re
    lp_inhouse_start = {}
    lp_outsource_start = {}
    
    for shift, count in lp_assignments.items():
        if shift in shift_coverage:
            info = shift_coverage[shift]
            start = info['start']
            
            if info['company'] == 'inhouse':
                lp_inhouse_start[start] = lp_inhouse_start.get(start, 0) + count
            else:
                lp_outsource_start[start] = lp_outsource_start.get(start, 0) + count
    
    # Slot bazÄ±nda
    lp_inhouse_slot = {}
    lp_outsource_slot = {}
    
    for slot in slots:
        count_in = 0
        count_out = 0
        
        for shift, count in lp_assignments.items():
            if shift in shift_coverage and df_shift_matrix.loc[slot, shift] == 1:
                info = shift_coverage[shift]
                if info['company'] == 'inhouse':
                    count_in += count
                else:
                    count_out += count
        
        lp_inhouse_slot[slot] = count_in
        lp_outsource_slot[slot] = count_out
    
    # =========================================
    # GRAFÄ°KLER
    # =========================================
    
    fig, axes = plt.subplots(2, 2, figsize=(16, 12))
    fig.suptitle(f'GerÃ§ek vs LP KarÅŸÄ±laÅŸtÄ±rmasÄ± - {date_str}', fontsize=14, fontweight='bold')
    
    # --- Grafik 1: Inhouse Vardiya BaÅŸlangÄ±Ã§ ---
    ax1 = axes[0, 0]
    all_starts = sorted(set(list(actual_inhouse_start.keys()) + list(lp_inhouse_start.keys())))
    x = range(len(all_starts))
    width = 0.35
    
    actual_vals = [actual_inhouse_start.get(s, 0) for s in all_starts]
    lp_vals = [lp_inhouse_start.get(s, 0) for s in all_starts]
    
    ax1.bar([i - width/2 for i in x], actual_vals, width, label='GerÃ§ek', color='#2E86AB', alpha=0.7)
    ax1.bar([i + width/2 for i in x], lp_vals, width, label='LP', color='#A23B72', alpha=0.7)
    
    ax1.set_xlabel('Vardiya BaÅŸlangÄ±Ã§ Saati')
    ax1.set_ylabel('KiÅŸi SayÄ±sÄ±')
    ax1.set_title('INHOUSE - Vardiya BaÅŸlangÄ±Ã§ DaÄŸÄ±lÄ±mÄ±')
    ax1.set_xticks(x)
    ax1.set_xticklabels(all_starts, rotation=45, ha='right', fontsize=8)
    ax1.legend()
    ax1.grid(axis='y', alpha=0.3)
    
    # --- Grafik 2: Outsource Vardiya BaÅŸlangÄ±Ã§ ---
    ax2 = axes[0, 1]
    all_starts = sorted(set(list(actual_outsource_start.keys()) + list(lp_outsource_start.keys())))
    x = range(len(all_starts))
    
    actual_vals = [actual_outsource_start.get(s, 0) for s in all_starts]
    lp_vals = [lp_outsource_start.get(s, 0) for s in all_starts]
    
    ax2.bar([i - width/2 for i in x], actual_vals, width, label='GerÃ§ek', color='#2E86AB', alpha=0.7)
    ax2.bar([i + width/2 for i in x], lp_vals, width, label='LP', color='#A23B72', alpha=0.7)
    
    ax2.set_xlabel('Vardiya BaÅŸlangÄ±Ã§ Saati')
    ax2.set_ylabel('KiÅŸi SayÄ±sÄ±')
    ax2.set_title('OUTSOURCE - Vardiya BaÅŸlangÄ±Ã§ DaÄŸÄ±lÄ±mÄ±')
    ax2.set_xticks(x)
    ax2.set_xticklabels(all_starts, rotation=45, ha='right', fontsize=8)
    ax2.legend()
    ax2.grid(axis='y', alpha=0.3)
    
    # --- Grafik 3: Slot BazÄ±nda Toplam ---
    ax3 = axes[1, 0]
    
    active_slots = [s for s in slots if 
                    actual_inhouse_slot[s] + actual_outsource_slot[s] > 0 or
                    lp_inhouse_slot[s] + lp_outsource_slot[s] > 0]
    
    actual_total = [actual_inhouse_slot[s] + actual_outsource_slot[s] for s in active_slots]
    lp_total = [lp_inhouse_slot[s] + lp_outsource_slot[s] for s in active_slots]
    
    ax3.plot(range(len(active_slots)), actual_total, 'o-', label='GerÃ§ek', color='#2E86AB', linewidth=2)
    ax3.plot(range(len(active_slots)), lp_total, 's--', label='LP', color='#A23B72', linewidth=2)
    
    ax3.set_xlabel('Slot')
    ax3.set_ylabel('KiÅŸi SayÄ±sÄ±')
    ax3.set_title('SLOT BAZINDA TOPLAM KÄ°ÅÄ° SAYISI')
    ax3.set_xticks(range(0, len(active_slots), 4))
    ax3.set_xticklabels([active_slots[i] for i in range(0, len(active_slots), 4)], rotation=45, ha='right')
    ax3.legend()
    ax3.grid(alpha=0.3)
    
    # --- Grafik 4: Slot BazÄ±nda Inhouse vs Outsource ---
    ax4 = axes[1, 1]
    
    ax4.plot(range(len(active_slots)), [actual_inhouse_slot[s] for s in active_slots], 
             'o-', label='GerÃ§ek Inhouse', color='#2E86AB', linewidth=2)
    ax4.plot(range(len(active_slots)), [actual_outsource_slot[s] for s in active_slots], 
             'o-', label='GerÃ§ek Outsource', color='#E94F37', linewidth=2)
    ax4.plot(range(len(active_slots)), [lp_inhouse_slot[s] for s in active_slots], 
             's--', label='LP Inhouse', color='#2E86AB', linewidth=1, alpha=0.7)
    ax4.plot(range(len(active_slots)), [lp_outsource_slot[s] for s in active_slots], 
             's--', label='LP Outsource', color='#E94F37', linewidth=1, alpha=0.7)
    
    ax4.set_xlabel('Slot')
    ax4.set_ylabel('KiÅŸi SayÄ±sÄ±')
    ax4.set_title('SLOT BAZINDA INHOUSE vs OUTSOURCE')
    ax4.set_xticks(range(0, len(active_slots), 4))
    ax4.set_xticklabels([active_slots[i] for i in range(0, len(active_slots), 4)], rotation=45, ha='right')
    ax4.legend()
    ax4.grid(alpha=0.3)
    
    plt.tight_layout()
    plt.savefig(f'comparison_{date_str}.png', dpi=150, bbox_inches='tight')
    plt.show()
    
    # =========================================
    # Ã–ZET TABLO
    # =========================================
    
    total_actual_in = sum(actual_inhouse_start.values())
    total_actual_out = sum(actual_outsource_start.values())
    total_lp_in = sum(lp_inhouse_start.values())
    total_lp_out = sum(lp_outsource_start.values())
    
    print(f"\nğŸ“Š Ã–ZET - {date_str}")
    print(f"{'-'*50}")
    print(f"{'':20} {'GerÃ§ek':>12} {'LP':>12}")
    print(f"{'-'*50}")
    print(f"{'Inhouse':20} {total_actual_in:>12} {total_lp_in:>12}")
    print(f"{'Outsource':20} {total_actual_out:>12} {total_lp_out:>12}")
    print(f"{'TOPLAM':20} {total_actual_in+total_actual_out:>12} {total_lp_in+total_lp_out:>12}")
    print(f"{'-'*50}")
    actual_ratio = total_actual_out / (total_actual_in + total_actual_out) * 100 if (total_actual_in + total_actual_out) > 0 else 0
    lp_ratio = total_lp_out / (total_lp_in + total_lp_out) * 100 if (total_lp_in + total_lp_out) > 0 else 0
    print(f"{'Outsource OranÄ±':20} {actual_ratio:>11.1f}% {lp_ratio:>11.1f}%")
    
    print(f"\nâœ“ Grafik kaydedildi: comparison_{date_str}.png")


# =============================================================================
# 5. VERÄ°LERÄ° HAZIRLA
# =============================================================================

queue = 'a_cagrilari'

df_eylul = df_actual[df_actual['working_date'].dt.month == 9]

weekend_dates = df_eylul[
    (df_eylul['line_based_main_group'] == queue) & 
    (df_eylul['weekend_flg'] == 1)
]['working_date'].unique()

print(f"\n{'='*60}")
print("EYLÃœL HAFTA SONU - Ä°KÄ° AÅAMALI LP")
print(f"{'='*60}")
print(f"Hafta sonu gÃ¼nÃ¼: {len(weekend_dates)}")

df_shifts_filtered = df_shifts[df_shifts['company'].isin(queue_company_rules[queue])]
shift_coverage = create_shift_coverage_matrix(df_shifts_filtered)
df_shift_matrix = calculate_shift_slot_matrix(shift_coverage)

print(f"\nKullanÄ±labilir Shift: {len(shift_coverage)}")
print(f"  Inhouse: {sum([1 for s in shift_coverage.values() if s['company']=='inhouse'])}")
print(f"  Outsource: {sum([1 for s in shift_coverage.values() if s['company']=='outsource'])}")


# =============================================================================
# 6. TEST SENARYOLARI
# =============================================================================

test_scenarios = [
    {'name': 'Baseline (kÄ±sÄ±tsÄ±z)', 'min': None, 'max': None},
    {'name': 'Hedef %50-%55', 'min': 0.50, 'max': 0.55},
    {'name': 'Hedef %50-%60', 'min': 0.50, 'max': 0.60},
    {'name': 'Hedef %55-%60', 'min': 0.55, 'max': 0.60},
    {'name': 'Hedef %55-%65', 'min': 0.55, 'max': 0.65},
    {'name': 'Hedef %52-%58', 'min': 0.52, 'max': 0.58},
    {'name': 'Hedef %45-%55', 'min': 0.45, 'max': 0.55},
]


# =============================================================================
# 7. TESTLERÄ° Ã‡ALIÅTIR
# =============================================================================

all_results = []

for scenario in test_scenarios:
    print(f"\n{'='*70}")
    print(f"ğŸ“‹ {scenario['name']}")
    print(f"{'='*70}")
    
    scenario_results = []
    stage_counts = {'AÅŸama 1': 0, 'AÅŸama 2': 0, 'BaÅŸarÄ±sÄ±z': 0}
    
    for date in weekend_dates:
        actual_by_slot = calculate_actual_by_slot(df_actual, date, queue)
        
        if scenario['min'] is None:
            # Baseline: sadece ihtiyaÃ§ constraint
            slots = df_shift_matrix.index.tolist()
            shifts = df_shift_matrix.columns.tolist()
            active_slots = [s for s in slots if actual_by_slot.get(s, 0) > 0]
            
            c = [1.0] * len(shifts)
            A_ub = []
            b_ub = []
            
            for slot in active_slots:
                row = []
                for s in shifts:
                    if df_shift_matrix.loc[slot, s] == 1:
                        row.append(-1)
                    else:
                        row.append(0)
                A_ub.append(row)
                b_ub.append(-actual_by_slot[slot])
            
            bounds = [(0, 200)] * len(shifts)
            result = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method='highs')
            
            if result.success:
                lp_assignments = {}
                for i, shift in enumerate(shifts):
                    if result.x[i] > 0.01:
                        lp_assignments[shift] = int(np.ceil(result.x[i]))
                stage_info = "Baseline"
            else:
                lp_assignments = None
                stage_info = "BaÅŸarÄ±sÄ±z"
        else:
            lp_assignments, stage_info = optimize_two_stage(
                actual_by_slot, 
                df_shift_matrix,
                target_min=scenario['min'],
                target_max=scenario['max']
            )
        
        # Stage sayacÄ±
        if 'AÅŸama 1' in stage_info:
            stage_counts['AÅŸama 1'] += 1
        elif 'AÅŸama 2' in stage_info:
            stage_counts['AÅŸama 2'] += 1
        elif 'Baseline' in stage_info:
            stage_counts['AÅŸama 1'] += 1
        else:
            stage_counts['BaÅŸarÄ±sÄ±z'] += 1
        
        if lp_assignments:
            analysis = analyze_lp_result(lp_assignments, shift_coverage, df_shift_matrix, actual_by_slot)
            if analysis:
                scenario_results.append({
                    'date': date,
                    'stage': stage_info,
                    'analysis': analysis
                })
    
    if scenario_results:
        avg_outsource_pct = np.mean([r['analysis']['outsource_pct'] for r in scenario_results])
        avg_peak_outsource_pct = np.mean([r['analysis']['peak_outsource_pct'] for r in scenario_results])
        
        print(f"\nğŸ“Š SONUÃ‡LAR ({len(scenario_results)} gÃ¼n):")
        print(f"   GÃ¼nlÃ¼k Ort. Outsource: %{avg_outsource_pct:.1f}")
        print(f"   Zirve Slot Outsource:  %{avg_peak_outsource_pct:.1f}")
        print(f"\n   AÅŸama DaÄŸÄ±lÄ±mÄ±:")
        print(f"   - AÅŸama 1 yeterli: {stage_counts['AÅŸama 1']} gÃ¼n")
        print(f"   - AÅŸama 2 gerekti: {stage_counts['AÅŸama 2']} gÃ¼n")
        print(f"   - BaÅŸarÄ±sÄ±z: {stage_counts['BaÅŸarÄ±sÄ±z']} gÃ¼n")
        
        all_results.append({
            'scenario': scenario['name'],
            'avg_outsource_pct': avg_outsource_pct,
            'avg_peak_outsource_pct': avg_peak_outsource_pct,
            'stage_counts': stage_counts,
            'results': scenario_results
        })
    else:
        print("   âš ï¸ Ã‡Ã¶zÃ¼m bulunamadÄ±!")
        all_results.append({
            'scenario': scenario['name'],
            'avg_outsource_pct': None,
            'avg_peak_outsource_pct': None,
            'stage_counts': stage_counts,
            'results': []
        })


# =============================================================================
# 8. KARÅILAÅTIRMA TABLOSU
# =============================================================================

print(f"\n{'='*80}")
print("KARÅILAÅTIRMA TABLOSU")
print(f"{'='*80}")

print(f"\n{'Senaryo':<25} {'GÃ¼nlÃ¼k Ort.':<12} {'Zirve Slot':<12} {'AÅŸama 1':<10} {'AÅŸama 2':<10}")
print(f"{'-'*25} {'-'*12} {'-'*12} {'-'*10} {'-'*10}")
print(f"{'GERÃ‡EK (EylÃ¼l)':<25} {'%55':<12} {'%60':<12} {'-':<10} {'-':<10}")
print(f"{'-'*25} {'-'*12} {'-'*12} {'-'*10} {'-'*10}")

for result in all_results:
    name = result['scenario'][:24]
    if result['avg_outsource_pct'] is not None:
        daily = f"%{result['avg_outsource_pct']:.1f}"
        peak = f"%{result['avg_peak_outsource_pct']:.1f}"
        s1 = str(result['stage_counts']['AÅŸama 1'])
        s2 = str(result['stage_counts']['AÅŸama 2'])
    else:
        daily = "Ã‡Ã¶zÃ¼m yok"
        peak = "-"
        s1 = "-"
        s2 = "-"
    
    print(f"{name:<25} {daily:<12} {peak:<12} {s1:<10} {s2:<10}")


# =============================================================================
# 9. DETAYLI GÃœNLÃœK SONUÃ‡LAR (Hedef %55-%60)
# =============================================================================

target_scenario = None
for r in all_results:
    if r['scenario'] == 'Hedef %55-%60' and r['results']:
        target_scenario = r
        break

if target_scenario:
    print(f"\n{'='*80}")
    print("DETAYLI GÃœNLÃœK SONUÃ‡LAR - Hedef %55-%60")
    print(f"{'='*80}")
    
    print(f"\n{'Tarih':<12} {'Outsource %':<12} {'Zirve Out %':<12} {'AÅŸama':<30}")
    print(f"{'-'*12} {'-'*12} {'-'*12} {'-'*30}")
    
    for r in target_scenario['results']:
        date_str = pd.to_datetime(r['date']).strftime('%Y-%m-%d')
        out_pct = f"%{r['analysis']['outsource_pct']:.1f}"
        peak_pct = f"%{r['analysis']['peak_outsource_pct']:.1f}"
        stage = r['stage'][:29]
        print(f"{date_str:<12} {out_pct:<12} {peak_pct:<12} {stage:<30}")


# =============================================================================
# 10. SHIFT ATAMALARI DETAYI (SAAT BÄ°LGÄ°SÄ° Ä°LE)
# =============================================================================

target_scenario_name = 'Hedef %55-%60'

for r in all_results:
    if r['scenario'] == target_scenario_name and r['results']:
        print(f"\n{'='*80}")
        print(f"SHIFT ATAMALARI - {target_scenario_name}")
        print(f"{'='*80}")
        
        for day_result in r['results'][:3]:  # Ä°lk 3 gÃ¼n
            date_str = pd.to_datetime(day_result['date']).strftime('%Y-%m-%d')
            
            actual_by_slot = calculate_actual_by_slot(df_actual, day_result['date'], queue)
            lp_assignments, stage_info = optimize_two_stage(
                actual_by_slot, 
                df_shift_matrix,
                target_min=0.55,
                target_max=0.60
            )
            
            print(f"\nğŸ“… {date_str} - {stage_info}")
            print(f"{'-'*60}")
            
            # Inhouse shift'ler
            print("\nINHOUSE:")
            print(f"   {'Shift':<25} {'Saat':<15} {'KiÅŸi':<10}")
            print(f"   {'-'*25} {'-'*15} {'-'*10}")
            for shift, count in sorted(lp_assignments.items()):
                if 'inhouse' in shift.lower() and shift in shift_coverage:
                    info = shift_coverage[shift]
                    saat = f"{info['start']}-{info['end']}"
                    print(f"   {shift:<25} {saat:<15} {count:<10}")
            
            # Outsource shift'ler
            print("\nOUTSOURCE:")
            print(f"   {'Shift':<25} {'Saat':<15} {'KiÅŸi':<10}")
            print(f"   {'-'*25} {'-'*15} {'-'*10}")
            for shift, count in sorted(lp_assignments.items()):
                if 'outsource' in shift.lower() and shift in shift_coverage:
                    info = shift_coverage[shift]
                    saat = f"{info['start']}-{info['end']}"
                    print(f"   {shift:<25} {saat:<15} {count:<10}")
            
            # Toplam
            total_in = sum(c for s, c in lp_assignments.items() if 'inhouse' in s.lower())
            total_out = sum(c for s, c in lp_assignments.items() if 'outsource' in s.lower())
            print(f"\n   TOPLAM: Inhouse={total_in}, Outsource={total_out}, Oran=%{total_out/(total_in+total_out)*100:.1f}")
        
        break


# =============================================================================
# 11. SENARYO KARÅILAÅTIRMA GRAFÄ°KLERÄ°
# =============================================================================

fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# Grafik 1: GÃ¼nlÃ¼k Ortalama
ax1 = axes[0]
scenarios_with_results = [r for r in all_results if r['avg_outsource_pct'] is not None]
scenarios_names = [r['scenario'] for r in scenarios_with_results]
daily_values = [r['avg_outsource_pct'] for r in scenarios_with_results]

colors = ['#2E86AB' if 'Baseline' in n else '#A23B72' for n in scenarios_names]
bars1 = ax1.bar(range(len(scenarios_names)), daily_values, color=colors, alpha=0.7)

ax1.axhline(y=55, color='red', linestyle='--', label='GerÃ§ek (%55)', linewidth=2)
ax1.axhspan(55, 60, alpha=0.2, color='green', label='Hedef Bant (%55-60)')

ax1.set_ylabel('Outsource OranÄ± (%)')
ax1.set_title('GÃ¼nlÃ¼k Ortalama Outsource OranÄ±', fontweight='bold')
ax1.set_xticks(range(len(scenarios_names)))
ax1.set_xticklabels(scenarios_names, rotation=45, ha='right', fontsize=9)
ax1.legend(loc='upper right')
ax1.grid(axis='y', alpha=0.3)
ax1.set_ylim(30, 85)

for i, v in enumerate(daily_values):
    ax1.text(i, v + 1, f'%{v:.1f}', ha='center', fontsize=8)

# Grafik 2: Zirve Slot
ax2 = axes[1]
peak_values = [r['avg_peak_outsource_pct'] for r in scenarios_with_results]

bars2 = ax2.bar(range(len(scenarios_names)), peak_values, color=colors, alpha=0.7)

ax2.axhline(y=60, color='red', linestyle='--', label='GerÃ§ek (%60)', linewidth=2)
ax2.axhspan(55, 65, alpha=0.2, color='green', label='Hedef Bant (%55-65)')

ax2.set_ylabel('Outsource OranÄ± (%)')
ax2.set_title('Zirve Slot Outsource OranÄ±', fontweight='bold')
ax2.set_xticks(range(len(scenarios_names)))
ax2.set_xticklabels(scenarios_names, rotation=45, ha='right', fontsize=9)
ax2.legend(loc='upper right')
ax2.grid(axis='y', alpha=0.3)
ax2.set_ylim(30, 90)

for i, v in enumerate(peak_values):
    ax2.text(i, v + 1, f'%{v:.1f}', ha='center', fontsize=8)

plt.tight_layout()
plt.savefig('lp_two_stage_results.png', dpi=150, bbox_inches='tight')
plt.show()

print("\nâœ“ Grafik kaydedildi: lp_two_stage_results.png")


# =============================================================================
# 12. GERÃ‡EK VS LP KARÅILAÅTIRMA GRAFÄ°KLERÄ°
# =============================================================================

# =============================================================================
# 12. GERÃ‡EK VS LP KARÅILAÅTIRMA GRAFÄ°KLERÄ°
# =============================================================================

target_scenario_name = 'Baseline (kÄ±sÄ±tsÄ±z)'  # veya istediÄŸin senaryo

for r in all_results:
    if r['scenario'] == target_scenario_name and r['results']:
        
        for day_result in r['results'][:2]:  # Ä°lk 2 gÃ¼n
            date = day_result['date']
            
            actual_by_slot = calculate_actual_by_slot(df_actual, date, queue)
            
            # Baseline iÃ§in ayrÄ± kontrol
            if 'Baseline' in target_scenario_name:
                # Baseline: sadece ihtiyaÃ§ constraint
                slots = df_shift_matrix.index.tolist()
                shifts = df_shift_matrix.columns.tolist()
                active_slots = [s for s in slots if actual_by_slot.get(s, 0) > 0]
                
                c = [1.0] * len(shifts)
                A_ub = []
                b_ub = []
                
                for slot in active_slots:
                    row = []
                    for s in shifts:
                        if df_shift_matrix.loc[slot, s] == 1:
                            row.append(-1)
                        else:
                            row.append(0)
                    A_ub.append(row)
                    b_ub.append(-actual_by_slot[slot])
                
                bounds = [(0, 200)] * len(shifts)
                result = linprog(c, A_ub=A_ub, b_ub=b_ub, bounds=bounds, method='highs')
                
                lp_assignments = {}
                for i, shift in enumerate(shifts):
                    if result.x[i] > 0.01:
                        lp_assignments[shift] = int(np.ceil(result.x[i]))
                stage_info = "Baseline"
            else:
                # Hedefli senaryolar
                scenario = next(s for s in test_scenarios if s['name'] == target_scenario_name)
                lp_assignments, stage_info = optimize_two_stage(
                    actual_by_slot, 
                    df_shift_matrix,
                    target_min=scenario['min'],
                    target_max=scenario['max']
                )
            
            print(f"\n{'='*80}")
            print(f"ğŸ“… {pd.to_datetime(date).strftime('%Y-%m-%d')} - {stage_info}")
            print(f"{'='*80}")
            
            compare_actual_vs_lp(date, queue, df_actual, lp_assignments, shift_coverage, df_shift_matrix)
        
        break

print("\nâœ“ TamamlandÄ±!")
